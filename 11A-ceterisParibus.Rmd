---
output:
  pdf_document: default
  html_document: default
---
<<<<<<< HEAD
# Ceteris-paribus Oscillations - a Tool for Local Variable-importance  {#ceterisParibusOscillations}
=======
# Ceteris-paribus Oscillations and Local Variable-importance  {#ceterisParibusOscillations}
>>>>>>> 898a606cf7f177f6aeecac8c3b804ff1082ee50e

## Introduction {#CPOscIntro}

Visual examination of Ceteris-paribus (CP) profiles is insightful, but for a model with a large number of explanatory variables we may end up with a large number of plots which may be overwhelming. To prioritize between the profiles we need a measure that would summarize the impact of a selected variable on model's predictions. In this chapter we describe a solution closely linked with CP profiles. An alternative is also discussed in the Chapters \@ref(breakDown) and \@ref(shapley).

## Intuition {#CPOscIntuition}

To assign importance to CP profiles, we can use the concept of profile oscillations. In particular, the larger influence of an explanatory variable on prediction at a particular instance, the larger the fluctuations along the corresponding CP profile. For a variable that exercises little or no influence on model prediction, the profile will be flat or will barely change. Figure \@ref(fig:CPVIPprofiles) illustrates the idea behind measuring oscillations. The figure corresponds to the CP profiles presented in Figure \@ref(fig:profileV4Rf). 

The larger the highlighted area, the more important is the variable.

```{r CPVIPprofiles, echo=FALSE, fig.cap="(fig:CPVIPprofiles) The value of the colored area summarizes the CP oscillations and provides the mean of the absolute deviations between the CP profile and the instance prediction. Panel A shows continuous variables while panel B shows categorical variables. Example for the `titanic_rf_v6` model.", out.width = '99%', fig.align='center'}
knitr::include_graphics("figure/profile_v4_rf2.png")
```

## Method {#CPOscMethod}

Let us formalize this concept now. Denote by $g^j(z)$ the probability density function of the distribution of the $j$-th explanatory variable. The summary measure of the variable's importance for model prediction at point $x$, $vip^{CP}_j(x)$, computed based on the variable's CP profile, is defined as follows: 

$$
vip^{CP}_j(x^*) = \int_{\mathcal R} |CP^{f,j,x^*}(z) - f(x^*)| g^j(z)dz=E_{X_j}[|CP^{f,j,x^*}(X_j) - f(x^*)|].
$$
Thus, $vip^{CP}_j(x^*)$ is the expected absolute deviation of the CP profile from the model prediction for $x^*$ over the distribution of the $j$-th explanatory variable. A straightforward estimator of $vip^{CP}_j(x^*)$ is

$$
\widehat{ vip^{CP}_j(x^*)} = \frac 1n \sum_{i=1}^n |CP^{f,j,x^*}(x^{*j}_i) - f(x^*)|,
$$
where index $i$ goes through all observations in a dataset. 

Note that the importance of an explanatory variable for instance prediction may be very different for different points $x^*$. For example, consider model 
$$
f(x_1, x_2) = x_1 * x_2,
$$
where $x_1$ and $x_2$ take values in $[0,1]$. Consider prediction for an observation described by vector $x^* = (0,1)$. In that case, the importance of $X_1$ is larger than $X_2$. This is because the CP profile for the first variable, given by the values of function $f(z,1)=z$, will have oscillations, while the profile for the second variable will show no oscillation, because it is given by function $f(0,z)=0$. Obviously, the situation is reversed for $x^*=(1,0)$. 

## Example: Titanic data {#CPOscExample}

Figure \@ref(fig:CPVIP1) provides a bbarplot of variable importance measures for different continuous explanatory variables for the logistic regression model (`titanic_lmr_v6`) for `henry`. 

The longer the bar, the larger the CP-profile oscillations for a particular explanatory variable. Thus, Figure \@ref(fig:CPVIP1) indicates that the most important variable for prediction for the selected observation are `gender` and `sibsp`, followed by `age`. 

If Henry were older, this would significantly lower the chances of survival. One the other hand, Henry were not travelling alone, this would increase these chances. 

```{r CPVIP1, echo=FALSE, fig.cap="(fig:CPVIP1) Variable-importance measures calculated for Ceteris-paribus oscillations for `henry` based on the `titanic_rf_v6` model", out.width = '75%', fig.align='center'}
knitr::include_graphics("figure/oscillations_all_lmr_plot.png")
```


## Pros and cons {#CPOscProsCons}

Oscillations of CP profiels are easy to interpret and understand. By using the average of oscillations it is possible to select the most important variables for instance prediction. The methodology can easily be extended to two or more variables. 

There are several issues related to the use of the CP oscillations. For instance, the oscillations may not be of help in situations when the use of CP profiles may itself be problematic (e.g., in the case of correlated explanatory variables or interactions - see Section \@ref(CPProsCons)). An important issue is that the local variable importances do not sum up to the instsance prediction for which they are calculated. In Chapters \@ref(breakDown) and \@ref(shapley) we will introduce measures that address this problem.

## Code snippets for R {#CPOscR}

In this section we present key features of the R package `ingredients` which is a part of `DrWhy.AI` universe and covers all methods presented in this chapter. More details and examples can be found at https://modeloriented.github.io/ingredients/.

In this section, we use a random forest classification model developed in the chapter \@ref(TitanicDataset), namely the `titanic_rf_v6` model. It is trained to predict probability of survival from sinking of Titanic. Instance level explanations are calculated for a single observation `henry` - 47 years old passenger that travels 1st class.

`DALEX` explainers for both models and the Henry data are retrieved via `archivist` hooks as listed in Chapter \@ref(ListOfModelsTitanic). 

```{r, warning=FALSE, message=FALSE, eval=FALSE}
library("randomForest")
explain_rf_v6 <- archivist::aread("pbiecek/models/9b971")

library("DALEX")
henry <- archivist::aread("pbiecek/models/a6538")
henry
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
library("randomForest")
library("DALEX")
load("models/explain_rf_v6.rda")
load("models/henry.rda")
```

### Basic usage for the `calculate_oscillations` function

To calculate CP oscillations, we have got to calculate CP profiles for the selected observation. Let us use  `henry` as the instance prediction of interest.

CP profiles are calculated by applying the `ceteris_paribus()` function to the wrapper object. Resulting object can be then processed with `calculate_oscillations()`.

```{r titanicCeterisProfile02C, warning=FALSE, message=FALSE}
library("ingredients")
library("ggplot2")

cp_titanic_rf <- ceteris_paribus(explain_rf_v6, henry)
```

<<<<<<< HEAD
Moreover, to calculate oscillations, we have got to calculate CP profiles for the selected observation. Let us use  `henry` as the instance prediction of interest.

[TOMASZ: WHY NOT USING THE PRE-DEFINED DATA FRAME?]

```{r, warning=FALSE, message=FALSE}
henry <- data.frame(
  class = factor("1st", levels = c("1st", "2nd", "3rd", "deck crew", "engineering crew", 
                                  "restaurant staff", "victualling crew")),
  gender = factor("male", levels = c("female", "male")),
  age = 8,
  sibsp = 0,
  parch = 0,
  fare = 72,
  embarked = factor("Southampton", levels = c("Belfast", "Cherbourg", "Queenstown", "Southampton"))
)
```

CP profiles are calculated by applying the `ceteris_paribus()` function to the wrapper object.
=======
The `calculate_oscillations()` function returns an object of class `ceteris_paribus_oscillations`, which has a form of a data frame, but has also an overloaded `plot()` function. We can use the latter function to plot the local variable-importance measures for the instance of interest.

 
```{r titanicCeterisProfile02D, warning=FALSE, message=FALSE}
oscillations_titanic_rf <- calculate_oscillations(cp_titanic_rf)
oscillations_titanic_rf
```

It can be then plotted with the generic `plot()`.
>>>>>>> 898a606cf7f177f6aeecac8c3b804ff1082ee50e

```{r titanicCeterisProfile02E, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, out.width = '70%', fig.align='center'}
oscillations_titanic_rf$`_ids_` <- "Henry"
plot(oscillations_titanic_rf) + ggtitle("Ceteris Paribus Oscillations")
```


### Advanced usage for the `calculate_oscillations` function

Note, that the `calculate_oscillations` function calculates $\widehat{ vip^{CP}_j(x^*)}$ as an average absolute difference between Ceteriws Paribus profile and the model prediction for a selected instance over selected grid of values.

The choice of grid of values may influence results as the expectation will be calculated over different distributions.

The default behavior is to use all unique values as grid points. But let us consider two alternative approaches.

One would be to calculate the expectation over uniform distribution for continuous variables. 

To do this we manually specify a dense uniform grid of values for each variable.
Here we are doing it by setting the `variable_splits` argument.

```{r titanicCeterisProfile02F, warning=FALSE, message=FALSE}
cp_titanic_rf_uniform <- ceteris_paribus(explain_rf_v6, henry, 
              variable_splits = list(age = seq(0, 65, 0.1),
                                     fare = seq(0, 200, 0.1),
                                     sibsp = seq(0, 8, 0.1),
                                     parch = seq(0, 8, 0.1),
                                     gender = unique(titanic$gender),
                                     embarked = unique(titanic$embarked),
                                     class = unique(titanic$class)))
```

Calculation of oscillations is easy.

```{r titanicCeterisProfile02G, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, out.width = '70%', fig.align='center'}
oscillations_uniform <- calculate_oscillations(cp_titanic_rf_uniform)
oscillations_uniform$`_ids_` <- "Henry"
oscillations_uniform
plot(oscillations_uniform) + ggtitle("Ceteris Paribus Oscillations", "Expectation over uniform distribution")
```

<<<<<<< HEAD
For the selected profiles, we calculate the average oscillations with the help of the `calculate_oscillations()` function. [TOMASZ: NO FACTORS?]
=======
>>>>>>> 898a606cf7f177f6aeecac8c3b804ff1082ee50e

Another approach would be to average over empirical distribution of each variable. 

To do this we manually specify grid of values as a sample from validation data.

```{r titanicCeterisProfile02H, warning=FALSE, message=FALSE}
titanic <- na.omit(titanic)

cp_titanic_rf_empirical <- ceteris_paribus(explain_rf_v6, henry, 
              variable_splits = list(age = titanic$age,
                                     fare = titanic$fare,
                                     sibsp = titanic$sibsp,
                                     parch = titanic$parch,
                                     gender = titanic$gender,
                                     embarked = titanic$embarked,
                                     class = titanic$class))
```

<<<<<<< HEAD
The `calculate_oscillations()` function returns an object of class `ceteris_paribus_oscillations`, which has a form of a data frame, but has also an overloaded `plot()` function. We can use the latter function to plot the local variable-importance measures for the instance of interest.
=======
Having profiles we can then calculate oscillations with `calculate_oscillations`.
>>>>>>> 898a606cf7f177f6aeecac8c3b804ff1082ee50e

```{r titanicCeterisProfile02I, warning=FALSE, message=FALSE, fig.width=6, fig.height=4, out.width = '70%', fig.align='center'}
oscillations_empirical <- calculate_oscillations(cp_titanic_rf_empirical)
oscillations_empirical$`_ids_` <- "Henry"
oscillations_empirical
plot(oscillations_empirical) + ggtitle("Ceteris Paribus Oscillations", "Expectation over empirical distribution")
```





```{r, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=7, fig.cap="Ceteris-paribus profiles for numerical variables in the random forest model `titanic_rf_v6` and Henry.", out.width = '70%', fig.align='center', eval=FALSE, echo=FALSE}
cp_titanic_rf <- ceteris_paribus(explain_rf_v6, henry, 
              variable_splits = list(age = seq(0,65, 0.1),
                                     fare = seq(0,200,0.1),
                                     sibsp = seq(0,8,0.1),
                                     parch = seq(0,8,0.1),
                                     gender = unique(titanic$gender),
                                     embarked = unique(titanic$embarked),
                                     class = unique(titanic$class)))

plot(cp_titanic_rf) +
  show_observations(cp_titanic_rf, variables = c("age", "fare", "sibsp", "parch")) +
  ggtitle("Ceteris-paribus Profile", "For the `titanic_rf_v6` random forest, Titanic dataset, and Henry")
```

```{r titanicCeterisProfile02B, warning=FALSE, message=FALSE, echo=FALSE, fig.width=7, fig.height=5, fig.cap="Ceteris-paribus profiles for categorical variables and random forest model `titanic_rf_v6` and Henry.", out.width = '70%', fig.align='center', eval=FALSE, echo=FALSE}
plot(cp_titanic_rf, only_numerical = FALSE, facet_ncol = 1) +
  ggtitle("Ceteris-paribus Profile", "For the `titanic_rf_v6` random forest, Titanic dataset, and Henry")
```


