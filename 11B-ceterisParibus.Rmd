---
output:
  pdf_document: default
  html_document: default
---
#  Ceteris-Paribus 2D Profiles - a tool for pairwise interactions {#ceterisParibus2d}

## Introduction

The definition of Ceteris Paribus profiles, given in Section \@ref(ceterisParibus), may be easily extended to two or more explanatory variables. Also, the definition of the variance importance measure $vip^{CP}_j(x^*)$ have a straightforward extension for a larger number of variables. 

Such extension is useful to identify or visualize of pairwise interactions between variables.

## Intuition

Figure \@ref(fig:profile2d) presents a response surface for a `titanic_lmr_v6` model for two explanatory variables, *age* and *sibsp*, from the *titanic* dataset (see Section \@ref(TitanicDataset)). We are interested in the change of the model prediction induced by each of the variables. 

```{r profile2d, echo=FALSE, fig.cap="(fig:profile2d) Ceteris-paribus profile for a pair of explanatory variables for a model `titanic_lmer_v6` for `age`  and `sibsp` variables.", out.width = '70%', fig.align='center'}
knitr::include_graphics("figure/profile_2d.png")
```


## Method

The definition of Ceteris Paribus profiles may be easily extended to two or more explanatory variables. 
A two-dimensional Ceteris Paribus profile for model $f$, explanatory variables $j$ and $k$, and point $x^*$ is defined as follows:

$$
CP^{f, (j,k), x^*}(z_1, z_2) \equiv f(x^*|^{(j,k)} = (z_1,z_2)).
$$

Ceteris Paribus 2D profile is a function that provides the dependence of the prediction of the model on the values of $j$-th and $k$-th explanatory variables $z_1$ and $z_2$, respectively, where $z_1$ and $z_2$ are taken to go through the range of values typical for the variables, and values of all other variables in $x^*$ are kept fixed at the values present in $x^*$.

The corresponding variance importance measure would be defined as follows: 
$$
vip^{CP}_{j,k}(x^*) = \int_{\mathcal R}\int_{\mathcal R} |CP^{f,(j,k),x^*}(z_1,z_2) - f(x^*)| g^{j,k}(z_1,z_2)dz_1dz_2=E_{X_j,X_k}[|CP^{f,j,x^*}(X_j,X_k) - f(x^*)|],
$$
where the expected value is taken over the joint distribution of the $j$-th and $k$-th explanatory variable.

Such multi-dimensional extensions are useful to check if, for instance, the model involves interactions. In particular, presence of pairwise interactions may be detected with two-dimensional (2D) CP profiles.

A natural way to visualize 2D CP profiles is to use a heat map for all pairs of explanatory variables as in Figure \@ref(fig:profile2dAll). 

```{r profile2dAll, echo=FALSE, fig.cap="(fig:profile2dAll) Ceteris-paribus profile for all pairs of explanatory variables for a `titanic_lmer_v6` model. Black cross marks the coordinates of the point of interest.", out.width = '90%', fig.align='center'}
knitr::include_graphics("figure/profile_2d_all.png")
```

If the number of pairs of explanatory variables is small or moderate, then it is possible to present 2D CP profiles for all pairs of variables.  

If the number of pairs is large, we can use the variable importance measure to order the pairs based on their importance and select the most important pairs for purposes of illustration.


## Pros and cons

Two-dimensional CP profiles can be used to identify the presence of pairwise interactions in a model. 

But number of pairs may be large and 3d profiles are more difficult to read than 1d profiles.


## Code snippets for R

In this section we present key features of the R package `ingredients` [@ingredientsRPackage] which is a part of `DALEXverse` and covers all methods presented in this chapter. More details and examples can be found at `https://modeloriented.github.io/ingredients/`.

There are also other R packages that offer similar functionality, like `condvis` [@JSSv081i05] or `ICEbox` [@ICEboxRPackage].

In this section we use a random forest [@R-randomForest] model `titanic_rf_v6` developed for the Titanic dataset (see Section \@ref(TitanicDataset)). In particular, we deal with a binary classification problem - we want to predict the probability of survival for a selected passenger.

```{r, warning=FALSE, message=FALSE, eval=FALSE}
titanic <- archivist::aread("pbiecek/models/27e5c")
titanic_rf_v6 <- archivist::aread("pbiecek/models/31570")
```

```{r, warning=FALSE, message=FALSE, echo=FALSE}
load("models/titanic_rf_v6.rda")
load("models/titanic.rda")
```

```{r, warning=FALSE, message=FALSE}
library("DALEX")
library("randomForest")
explain_titanic_rf <- explain(model = titanic_rf_v6, 
                              data = titanic[,-9],
                              y = titanic$survived == "yes", 
                              label = "Random Forest v6")
```

In order to calculate oscillations we need to first calculate Ceteris Paribus profiles for a selected observation. 

Let us use the `johny_d` instance again.

```{r, warning=FALSE, message=FALSE}
johny_d <- data.frame(
  class = factor("1st", levels = c("1st", "2nd", "3rd", "deck crew", "engineering crew", 
                                  "restaurant staff", "victualling crew")),
  gender = factor("male", levels = c("female", "male")),
  age = 8,
  sibsp = 0,
  parch = 0,
  fare = 72,
  embarked = factor("Southampton", levels = c("Belfast", "Cherbourg", "Queenstown", "Southampton"))
)
```

2D profiles are calculated with the `ceteris_paribus_2d()` function. By default all pairs between continuous variables are being plotted, but one can limit number of variables for consideration through the `variables` argument.

```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
library("ingredients")
library("ggplot2")

wi_rf_2d <- ceteris_paribus_2d(explain_titanic_rf, observation = titanic[31,], variables = c("age", "sibsp", "parch"))
head(wi_rf_2d)
```

Result is an object of the class `ceteris_paribus_2d_explainer` with overloaded `print()` and `plot()` function.

```{r titanicCeterisParibus06, warning=FALSE, message=FALSE, fig.width=8, fig.height=5}
plot(wi_rf_2d) + 
  theme(legend.position = "right", legend.direction = "vertical") + ggtitle("Ceteris Paribus 2D Profiles")

```

In the presented example both variables `age` and `sibsp` are important and influence the model response.


