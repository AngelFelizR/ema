<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Predictive Models: Visualisation, Exploration and Explanation</title>
  <meta name="description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Predictive Models: Visualisation, Exploration and Explanation" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Predictive Models: Visualisation, Exploration and Explanation" />
  
  <meta name="twitter:description" content="This is a minimal example of using the bookdown package to write a book. The output format for this example is bookdown::gitbook." />
  

<meta name="author" content="Przemyslaw Biecek and Tomasz Burzykowski">


<meta name="date" content="2018-09-23">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="shapley.html">
<link rel="next" href="ceterisParibus.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Predictive Models:<br/> Visualisation, Exploration and Explanation</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> Introduction</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#model-lifecycle"><i class="fa fa-check"></i><b>1.1</b> Model Lifecycle</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#why-do-we-need-model-explainers"><i class="fa fa-check"></i><b>1.2</b> Why do we need model explainers?</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#how-model-exploration-is-different-from-data-exploration"><i class="fa fa-check"></i><b>1.3</b> How model exploration is different from data exploration?</a></li>
<li class="chapter" data-level="1.4" data-path="index.html"><a href="index.html#black-box-models-vs-white-box-models"><i class="fa fa-check"></i><b>1.4</b> Black-box models vs White-box models</a></li>
<li class="chapter" data-level="1.5" data-path="index.html"><a href="index.html#model-agnostic-vs-model-specific"><i class="fa fa-check"></i><b>1.5</b> Model agnostic vs Model specific</a></li>
<li class="chapter" data-level="1.6" data-path="index.html"><a href="index.html#glossary-notation"><i class="fa fa-check"></i><b>1.6</b> Glossary / Notation</a></li>
<li class="chapter" data-level="1.7" data-path="index.html"><a href="index.html#thanksto"><i class="fa fa-check"></i><b>1.7</b> Thanks to</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="prediction-level-explanations.html"><a href="prediction-level-explanations.html"><i class="fa fa-check"></i>Prediction level explanations</a></li>
<li class="chapter" data-level="2" data-path="PredictionExplainers.html"><a href="PredictionExplainers.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="PredictionExplainers.html"><a href="PredictionExplainers.html#variable-attribution-vs-what-if-analysis"><i class="fa fa-check"></i><b>2.1</b> Variable attribution vs What-if analysis</a></li>
<li class="chapter" data-level="2.2" data-path="PredictionExplainers.html"><a href="PredictionExplainers.html#when-to-use"><i class="fa fa-check"></i><b>2.2</b> When to use?</a></li>
<li class="chapter" data-level="2.3" data-path="PredictionExplainers.html"><a href="PredictionExplainers.html#three-single-laws"><i class="fa fa-check"></i><b>2.3</b> A bit of philosophy: Three Laws for Prediction Level Explanations</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduction-to-variable-attribution-methods.html"><a href="introduction-to-variable-attribution-methods.html"><i class="fa fa-check"></i><b>3</b> Introduction to variable attribution methods</a><ul>
<li class="chapter" data-level="3.1" data-path="introduction-to-variable-attribution-methods.html"><a href="introduction-to-variable-attribution-methods.html#VAlinMod"><i class="fa fa-check"></i><b>3.1</b> Variable attribution for linear models</a><ul>
<li class="chapter" data-level="3.1.1" data-path="introduction-to-variable-attribution-methods.html"><a href="introduction-to-variable-attribution-methods.html#wine-quality-example"><i class="fa fa-check"></i><b>3.1.1</b> Wine quality example</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="introduction-to-variable-attribution-methods.html"><a href="introduction-to-variable-attribution-methods.html#modelAgnosticAttribution"><i class="fa fa-check"></i><b>3.2</b> Model agnostic approaches</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="breakDown.html"><a href="breakDown.html"><i class="fa fa-check"></i><b>4</b> Break Down Attributions</a><ul>
<li class="chapter" data-level="4.1" data-path="breakDown.html"><a href="breakDown.html#the-algorithm"><i class="fa fa-check"></i><b>4.1</b> The Algorithm</a></li>
<li class="chapter" data-level="4.2" data-path="breakDown.html"><a href="breakDown.html#hr-dataset-hire-or-fire"><i class="fa fa-check"></i><b>4.2</b> HR dataset: Hire or Fire?</a></li>
<li class="chapter" data-level="4.3" data-path="breakDown.html"><a href="breakDown.html#break-down-plots"><i class="fa fa-check"></i><b>4.3</b> Break Down Plots</a></li>
<li class="chapter" data-level="4.4" data-path="breakDown.html"><a href="breakDown.html#pros-and-cons"><i class="fa fa-check"></i><b>4.4</b> Pros and cons</a></li>
<li class="chapter" data-level="4.5" data-path="breakDown.html"><a href="breakDown.html#code-snippets-for-r"><i class="fa fa-check"></i><b>4.5</b> Code snippets for R</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html"><i class="fa fa-check"></i><b>5</b> Break Down for Interactions</a><ul>
<li class="chapter" data-level="5.1" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html#the-algorithm-1"><i class="fa fa-check"></i><b>5.1</b> The Algorithm</a></li>
<li class="chapter" data-level="5.2" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html#hr-dataset-hire-or-fire-1"><i class="fa fa-check"></i><b>5.2</b> HR dataset: Hire or Fire?</a></li>
<li class="chapter" data-level="5.3" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html#break-down-plots-1"><i class="fa fa-check"></i><b>5.3</b> Break Down Plots</a></li>
<li class="chapter" data-level="5.4" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html#pros-and-cons-1"><i class="fa fa-check"></i><b>5.4</b> Pros and cons</a></li>
<li class="chapter" data-level="5.5" data-path="break-down-for-interactions.html"><a href="break-down-for-interactions.html#code-snippets-for-r-1"><i class="fa fa-check"></i><b>5.5</b> Code snippets for R</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="shapley.html"><a href="shapley.html"><i class="fa fa-check"></i><b>6</b> Shapley Attributions</a><ul>
<li class="chapter" data-level="6.1" data-path="shapley.html"><a href="shapley.html#the-algorithm-2"><i class="fa fa-check"></i><b>6.1</b> The Algorithm</a></li>
<li class="chapter" data-level="6.2" data-path="shapley.html"><a href="shapley.html#code-snippets-for-r-2"><i class="fa fa-check"></i><b>6.2</b> Code snippets for R</a></li>
<li class="chapter" data-level="6.3" data-path="shapley.html"><a href="shapley.html#pros-and-cons-2"><i class="fa fa-check"></i><b>6.3</b> Pros and cons</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="LIME.html"><a href="LIME.html"><i class="fa fa-check"></i><b>7</b> Local approximations with white-box model</a><ul>
<li class="chapter" data-level="7.1" data-path="LIME.html"><a href="LIME.html#the-algorithm-3"><i class="fa fa-check"></i><b>7.1</b> The Algorithm</a></li>
<li class="chapter" data-level="7.2" data-path="LIME.html"><a href="LIME.html#hr-dataset-hire-or-fire-2"><i class="fa fa-check"></i><b>7.2</b> HR dataset: Hire or Fire?</a></li>
<li class="chapter" data-level="7.3" data-path="LIME.html"><a href="LIME.html#pros-and-cons-3"><i class="fa fa-check"></i><b>7.3</b> Pros and cons</a></li>
<li class="chapter" data-level="7.4" data-path="LIME.html"><a href="LIME.html#code-snippets-for-r-3"><i class="fa fa-check"></i><b>7.4</b> Code snippets for R</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="ceterisParibus.html"><a href="ceterisParibus.html"><i class="fa fa-check"></i><b>8</b> Ceteris Paribus Principle</a><ul>
<li class="chapter" data-level="8.1" data-path="ceterisParibus.html"><a href="ceterisParibus.html#introduction-1"><i class="fa fa-check"></i><b>8.1</b> Introduction</a></li>
<li class="chapter" data-level="8.2" data-path="ceterisParibus.html"><a href="ceterisParibus.html#ceterisParibus1d"><i class="fa fa-check"></i><b>8.2</b> 1D profiles</a></li>
<li class="chapter" data-level="8.3" data-path="ceterisParibus.html"><a href="ceterisParibus.html#oscillations"><i class="fa fa-check"></i><b>8.3</b> Profile oscillations</a></li>
<li class="chapter" data-level="8.4" data-path="ceterisParibus.html"><a href="ceterisParibus.html#d-profiles"><i class="fa fa-check"></i><b>8.4</b> 2D profiles</a></li>
<li class="chapter" data-level="8.5" data-path="ceterisParibus.html"><a href="ceterisParibus.html#local-model-fidelity"><i class="fa fa-check"></i><b>8.5</b> Local model fidelity</a></li>
<li class="chapter" data-level="8.6" data-path="ceterisParibus.html"><a href="ceterisParibus.html#pros-and-cons-4"><i class="fa fa-check"></i><b>8.6</b> Pros and cons</a></li>
<li class="chapter" data-level="8.7" data-path="ceterisParibus.html"><a href="ceterisParibus.html#code-snippets-for-r-4"><i class="fa fa-check"></i><b>8.7</b> Code snippets for R</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="model-level-explanations.html"><a href="model-level-explanations.html"><i class="fa fa-check"></i>Model level explanations</a></li>
<li class="chapter" data-level="9" data-path="introduction-2.html"><a href="introduction-2.html"><i class="fa fa-check"></i><b>9</b> Introduction</a><ul>
<li class="chapter" data-level="9.1" data-path="introduction-2.html"><a href="introduction-2.html#a-bit-of-philosophy"><i class="fa fa-check"></i><b>9.1</b> A bit of philosophy</a></li>
<li class="chapter" data-level="9.2" data-path="introduction-2.html"><a href="introduction-2.html#example-price-prediction"><i class="fa fa-check"></i><b>9.2</b> Example: Price prediction</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="variable-importance.html"><a href="variable-importance.html"><i class="fa fa-check"></i><b>10</b> Variable Importance</a></li>
<li class="chapter" data-level="11" data-path="marginal-response.html"><a href="marginal-response.html"><i class="fa fa-check"></i><b>11</b> Marginal Response</a><ul>
<li class="chapter" data-level="11.1" data-path="marginal-response.html"><a href="marginal-response.html#partial-dependency-plots"><i class="fa fa-check"></i><b>11.1</b> Partial Dependency Plots</a></li>
<li class="chapter" data-level="11.2" data-path="marginal-response.html"><a href="marginal-response.html#merging-path-plots"><i class="fa fa-check"></i><b>11.2</b> Merging Path Plots</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="performance-diagnostic.html"><a href="performance-diagnostic.html"><i class="fa fa-check"></i><b>12</b> Performance Diagnostic</a></li>
<li class="chapter" data-level="13" data-path="residual-diagnostic.html"><a href="residual-diagnostic.html"><i class="fa fa-check"></i><b>13</b> Residual Diagnostic</a></li>
<li class="chapter" data-level="14" data-path="other-topics.html"><a href="other-topics.html"><i class="fa fa-check"></i><b>14</b> Other topics</a></li>
<li class="chapter" data-level="" data-path="appendixes.html"><a href="appendixes.html"><i class="fa fa-check"></i>Appendixes</a></li>
<li class="chapter" data-level="15" data-path="DataSets.html"><a href="DataSets.html"><i class="fa fa-check"></i><b>15</b> Data Sets</a><ul>
<li class="chapter" data-level="15.1" data-path="DataSets.html"><a href="DataSets.html#HRdataset"><i class="fa fa-check"></i><b>15.1</b> Hire or Fire? HR in Call Center</a></li>
<li class="chapter" data-level="15.2" data-path="DataSets.html"><a href="DataSets.html#apartmentsDataset"><i class="fa fa-check"></i><b>15.2</b> How much does it cost? Price prediction for a square meter</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
<li class="divider"></li>
<li><a href="https://github.com/pbiecek/DALEX" target="blank">DALEX website</a></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Predictive Models: Visualisation, Exploration and Explanation</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="LIME" class="section level1">
<h1><span class="header-section-number">Chapter 7</span> Local approximations with white-box model</h1>
<p>A different approach to explanations of a single observations is through surrogate models. Models that easy to understand and are similar to black box model around the point of interest.</p>
<p>Variable attribution methods, that were presented in the Section <a href="breakDown.html#breakDown">4</a> are not interested in the local curvature of the model. They rather compare model prediction against average model prediction and they use probability structure of the dataset.</p>
<p>The complementary approach would be to directly explore information about model curvature around point of interest.
In the section <a href="ceterisParibus.html#ceterisParibus">8</a> we introduced Ceteris Paribus tool for such what-if analysis. But the limitation of ceteris Paribus pltos is that they explore changes along single dimension or pairs of dimensions.</p>
<p>In this section we describe an another approach based on local approximations with white-box models. This approach will also investigate local curvature of the model but indirectly, through surrogate white-box models.</p>
<p>The most known method from this class if LIME (Local Interpretable Model-Agnostic Explanations), introduced in the paper <em>Why Should I Trust You?: Explaining the Predictions of Any Classifier</em> <span class="citation">(Ribeiro, Singh, and Guestrin <a href="#ref-lime">2016</a>)</span>. This methods and it’s clones are now implemented in various R and python packages, see for example <span class="citation">(Pedersen and Benesty <a href="#ref-R-lime">2018</a>)</span>, <span class="citation">(Staniak and Biecek <a href="#ref-R-live">2018</a>)</span> or <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-iml"><strong>???</strong></span>)</span>.</p>
<div id="the-algorithm-3" class="section level2">
<h2><span class="header-section-number">7.1</span> The Algorithm</h2>
<p>The LIME method, and its clones, has following properties:</p>
<ul>
<li><em>model-agnostic</em>, they do not imply any assumptions on model structure,</li>
<li><em>interpretable representation</em>, model input is transformed into a feature space that is easier to understand. One of applications comes from image data, single pixels are not easy to interpret, thus the LIME method decompose image into a series of super pixels, that are easier to interpret to humans,</li>
<li><em>local fidelity</em> means that the explanations shall be locally well fitted to the black-box model.</li>
</ul>
<p>Therefore the objective is to find a local model <span class="math inline">\(M^L\)</span> that approximates the black box model <span class="math inline">\(f\)</span> in the point <span class="math inline">\(x^*\)</span>.
As a solution the penalized loss function is used. The white-box model that is used for explanations satisfies following condition.</p>
<p><span class="math display">\[
M^L(x^*) = \arg \min_{g \in G} L(f, g, \Pi_{x^*}) + \Omega (g) 
\]</span>
where <span class="math inline">\(G\)</span> is a family of white box models (e.g. linear models), <span class="math inline">\(\Pi_{x^*}\)</span> is neighbourhood of <span class="math inline">\(x^*\)</span> and <span class="math inline">\(\Omega\)</span> stands for model complexity.</p>
<div class="figure" style="text-align: center"><span id="fig:LIME1"></span>
<img src="figure/circle_4panels.png" alt="(fig:LIME1) A schematic idea behind local model approximations. Panel A shows training data, colors correspond to classess. Panel B showhs results fom the Random Forest model, whis is where the algorithm starts. Panel C shows new data sampled around the point of interest. Their color correspond to model response. Panel D shows fitted linear model that approximated the random forest model around point of interest" width="70%" />
<p class="caption">
Figure 7.1: (fig:LIME1) A schematic idea behind local model approximations. Panel A shows training data, colors correspond to classess. Panel B showhs results fom the Random Forest model, whis is where the algorithm starts. Panel C shows new data sampled around the point of interest. Their color correspond to model response. Panel D shows fitted linear model that approximated the random forest model around point of interest
</p>
</div>
<p>The algorithm is composed from three steps:</p>
<ul>
<li>Identification of interpretable data representations,</li>
<li>Local sampling around the point of interest,</li>
<li>Fitting a white box model in this neighbouhood</li>
</ul>
<p><strong>Identification of interpretable data representations</strong></p>
<p>For image data, single pixel is not an interpretable feature. In this step the input space of the model is transformed to input space that is easier to understand for human. The image may be decomposed into parts and represented as presence/absence of some part of an image.</p>
<p><strong>Local sampling around the point of interest</strong></p>
<p>Once the interpretable data representation is identified, then the neighbourhood around point of interest needs to be explored.</p>
<p><strong>Fitting a white box model in this neighbouhood</strong></p>
<p>Any model that is easy to interpret may be fitted to this data, like decision tree or rule based system. However in practice the most common family of models are linear models.</p>
</div>
<div id="hr-dataset-hire-or-fire-2" class="section level2">
<h2><span class="header-section-number">7.2</span> HR dataset: Hire or Fire?</h2>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;DALEX&quot;</span>)</a>
<a class="sourceLine" id="cb24-2" data-line-number="2"><span class="kw">library</span>(<span class="st">&quot;randomForest&quot;</span>)</a>
<a class="sourceLine" id="cb24-3" data-line-number="3">model &lt;-<span class="st"> </span><span class="kw">randomForest</span>(status <span class="op">~</span><span class="st"> </span>gender <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>hours <span class="op">+</span><span class="st"> </span>evaluation <span class="op">+</span><span class="st"> </span>salary, <span class="dt">data =</span> HR)</a>
<a class="sourceLine" id="cb24-4" data-line-number="4">model</a>
<a class="sourceLine" id="cb24-5" data-line-number="5"></a>
<a class="sourceLine" id="cb24-6" data-line-number="6">explainer_rf_fired &lt;-<span class="st"> </span><span class="kw">explain</span>(model,</a>
<a class="sourceLine" id="cb24-7" data-line-number="7">                 <span class="dt">data =</span> HR,</a>
<a class="sourceLine" id="cb24-8" data-line-number="8">                 <span class="dt">y =</span> HR<span class="op">$</span>status <span class="op">==</span><span class="st"> &quot;fired&quot;</span>,</a>
<a class="sourceLine" id="cb24-9" data-line-number="9">                 <span class="dt">predict_function =</span> <span class="cf">function</span>(m,x) <span class="kw">predict</span>(m,x, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)[,<span class="dv">1</span>],</a>
<a class="sourceLine" id="cb24-10" data-line-number="10">                 <span class="dt">label =</span> <span class="st">&quot;fired&quot;</span>)</a>
<a class="sourceLine" id="cb24-11" data-line-number="11"></a>
<a class="sourceLine" id="cb24-12" data-line-number="12"></a>
<a class="sourceLine" id="cb24-13" data-line-number="13">new_observation &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">gender =</span> <span class="kw">factor</span>(<span class="st">&quot;male&quot;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>)),</a>
<a class="sourceLine" id="cb24-14" data-line-number="14">                      <span class="dt">age =</span> <span class="fl">57.7</span>,</a>
<a class="sourceLine" id="cb24-15" data-line-number="15">                      <span class="dt">hours =</span> <span class="fl">42.3</span>,</a>
<a class="sourceLine" id="cb24-16" data-line-number="16">                      <span class="dt">evaluation =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb24-17" data-line-number="17">                      <span class="dt">salary =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb24-18" data-line-number="18"></a>
<a class="sourceLine" id="cb24-19" data-line-number="19"><span class="kw">predict</span>(model, new_observation, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)</a>
<a class="sourceLine" id="cb24-20" data-line-number="20"></a>
<a class="sourceLine" id="cb24-21" data-line-number="21"></a>
<a class="sourceLine" id="cb24-22" data-line-number="22"><span class="kw">library</span>(lime)</a>
<a class="sourceLine" id="cb24-23" data-line-number="23">model_type.randomForest &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;classification&quot;</span></a>
<a class="sourceLine" id="cb24-24" data-line-number="24">lime_rf &lt;-<span class="st"> </span><span class="kw">lime</span>(HR[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], model)</a>
<a class="sourceLine" id="cb24-25" data-line-number="25">lime<span class="op">::</span><span class="kw">explain</span>(new_observation[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], lime_rf, <span class="dt">n_labels =</span> <span class="dv">1</span>, <span class="dt">n_features =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb24-26" data-line-number="26"></a>
<a class="sourceLine" id="cb24-27" data-line-number="27"></a>
<a class="sourceLine" id="cb24-28" data-line-number="28"><span class="kw">library</span>(iml)</a>
<a class="sourceLine" id="cb24-29" data-line-number="29">mod =<span class="st"> </span>Predictor<span class="op">$</span><span class="kw">new</span>(model, <span class="dt">data =</span> HR[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</a>
<a class="sourceLine" id="cb24-30" data-line-number="30">x.interest =<span class="st"> </span>new_observation</a>
<a class="sourceLine" id="cb24-31" data-line-number="31">lemon =<span class="st"> </span>LocalModel<span class="op">$</span><span class="kw">new</span>(mod, <span class="dt">x.interest =</span> x.interest, <span class="dt">k =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb24-32" data-line-number="32">lemon</a>
<a class="sourceLine" id="cb24-33" data-line-number="33"></a>
<a class="sourceLine" id="cb24-34" data-line-number="34">lemon<span class="op">$</span>results</a>
<a class="sourceLine" id="cb24-35" data-line-number="35"><span class="kw">plot</span>(lemon)</a></code></pre></div>
</div>
<div id="pros-and-cons-3" class="section level2">
<h2><span class="header-section-number">7.3</span> Pros and cons</h2>
<p>Local approximations are model agnostic, can be applied to any predictive model. Below we summarize key strengths and weaknesses of this approach.</p>
<p><strong>Pros</strong></p>
<ul>
<li>This method is highly adopted in text analysis and image analysis, in part thanks to the interpretable data representations.</li>
<li>The intuition behind the model is straightforward</li>
<li>Model explanations are sparse, thus only small number of features is used</li>
</ul>
<p><strong>Cons</strong></p>
<ul>
<li>For continuous variables and tabular data it is not that easy to find interpretable representations</li>
<li>The black-box model approximated the data and the white box model approximates the black box model. We do not have control over the quality of local fit of the white box model, thus the surrogate model may be misleading.</li>
<li>Due to the <em>curse of dimensionality</em>, for high dimensional space points are sparse.</li>
</ul>
</div>
<div id="code-snippets-for-r-3" class="section level2">
<h2><span class="header-section-number">7.4</span> Code snippets for R</h2>
<p>In this section we present example application of <code>lime</code> <span class="citation">(Pedersen and Benesty <a href="#ref-R-lime">2018</a>)</span> and <code>live</code> <span class="citation">(Staniak and Biecek <a href="#ref-R-live">2018</a>)</span> packages. Note that this method is also implemented in <code>iml</code> <span class="citation">(<span class="citeproc-not-found" data-reference-id="R-iml"><strong>???</strong></span>)</span> and other packages. These pacakages differ in some details and also results in different explanations.</p>
<p><strong>Model preparation</strong></p>
<p>In this section we will present examples based on the <code>HR</code> dataset. See the Section <a href="DataSets.html#HRdataset">15.1</a> for more details.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;DALEX&quot;</span>)</a>
<a class="sourceLine" id="cb25-2" data-line-number="2"><span class="kw">head</span>(HR)</a></code></pre></div>
<pre><code>##   gender      age    hours evaluation salary   status
## 1   male 32.58267 41.88626          3      1    fired
## 2 female 41.21104 36.34339          2      5    fired
## 3   male 37.70516 36.81718          3      0    fired
## 4 female 30.06051 38.96032          3      2    fired
## 5   male 21.10283 62.15464          5      3 promoted
## 6   male 40.11812 69.53973          2      0    fired</code></pre>
<p>The problem here is to predict average price for square meter for an apartment. Let’s build a random forest model with <code>randomForest</code> package <span class="citation">(Breiman et al. <a href="#ref-R-randomForest">2018</a>)</span>.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;randomForest&quot;</span>)</a>
<a class="sourceLine" id="cb27-2" data-line-number="2">rf_model &lt;-<span class="st"> </span><span class="kw">randomForest</span>(status <span class="op">~</span><span class="st"> </span>gender <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>hours <span class="op">+</span><span class="st"> </span>evaluation <span class="op">+</span><span class="st"> </span>salary, <span class="dt">data =</span> HR)</a>
<a class="sourceLine" id="cb27-3" data-line-number="3">rf_model</a></code></pre></div>
<pre><code>## 
## Call:
##  randomForest(formula = status ~ gender + age + hours + evaluation +      salary, data = HR) 
##                Type of random forest: classification
##                      Number of trees: 500
## No. of variables tried at each split: 2
## 
##         OOB estimate of  error rate: 27.35%
## Confusion matrix:
##          fired   ok promoted class.error
## fired     2276  387      192   0.2028021
## ok         535 1246      440   0.4389914
## promoted   200  392     2179   0.2136413</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb29-1" data-line-number="1">new_observation &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">gender =</span> <span class="kw">factor</span>(<span class="st">&quot;male&quot;</span>, <span class="dt">levels =</span> <span class="kw">c</span>(<span class="st">&quot;male&quot;</span>, <span class="st">&quot;female&quot;</span>)),</a>
<a class="sourceLine" id="cb29-2" data-line-number="2">                      <span class="dt">age =</span> <span class="fl">57.7</span>,</a>
<a class="sourceLine" id="cb29-3" data-line-number="3">                      <span class="dt">hours =</span> <span class="fl">42.3</span>,</a>
<a class="sourceLine" id="cb29-4" data-line-number="4">                      <span class="dt">evaluation =</span> <span class="dv">2</span>,</a>
<a class="sourceLine" id="cb29-5" data-line-number="5">                      <span class="dt">salary =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb29-6" data-line-number="6"></a>
<a class="sourceLine" id="cb29-7" data-line-number="7"><span class="kw">predict</span>(rf_model, new_observation, <span class="dt">type =</span> <span class="st">&quot;prob&quot;</span>)</a></code></pre></div>
<pre><code>##   fired    ok promoted
## 1 0.818 0.174    0.008
## attr(,&quot;class&quot;)
## [1] &quot;matrix&quot; &quot;votes&quot;</code></pre>
<p><strong>The lime pacakge</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;lime&quot;</span>)</a>
<a class="sourceLine" id="cb31-2" data-line-number="2">model_type.randomForest &lt;-<span class="st"> </span><span class="cf">function</span>(x, ...) <span class="st">&quot;classification&quot;</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3">lime_rf &lt;-<span class="st"> </span><span class="kw">lime</span>(HR[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], rf_model)</a>
<a class="sourceLine" id="cb31-4" data-line-number="4">explanations &lt;-<span class="st"> </span>lime<span class="op">::</span><span class="kw">explain</span>(new_observation[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], lime_rf, <span class="dt">n_labels =</span> <span class="dv">3</span>, <span class="dt">n_features =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb31-5" data-line-number="5">explanations</a></code></pre></div>
<pre><code>##        model_type case    label label_prob  model_r2 model_intercept
## 1  classification    1    fired      0.818 0.1370186       0.2596377
## 2  classification    1    fired      0.818 0.1370186       0.2596377
## 3  classification    1    fired      0.818 0.1370186       0.2596377
## 4  classification    1    fired      0.818 0.1370186       0.2596377
## 5  classification    1    fired      0.818 0.1370186       0.2596377
## 6  classification    1       ok      0.174 0.1480372       0.2302089
## 7  classification    1       ok      0.174 0.1480372       0.2302089
## 8  classification    1       ok      0.174 0.1480372       0.2302089
## 9  classification    1       ok      0.174 0.1480372       0.2302089
## 10 classification    1       ok      0.174 0.1480372       0.2302089
## 11 classification    1 promoted      0.008 0.2862806       0.5101671
## 12 classification    1 promoted      0.008 0.2862806       0.5101671
## 13 classification    1 promoted      0.008 0.2862806       0.5101671
## 14 classification    1 promoted      0.008 0.2862806       0.5101671
## 15 classification    1 promoted      0.008 0.2862806       0.5101671
##    model_prediction    feature feature_value feature_weight
## 1        0.59035576     gender           2.0    0.020499061
## 2        0.59035576        age          57.7    0.015371225
## 3        0.59035576      hours          42.3    0.261426182
## 4        0.59035576 evaluation           2.0    0.109863364
## 5        0.59035576     salary           2.0   -0.076441786
## 6        0.36316835     gender           2.0   -0.031721934
## 7        0.36316835        age          57.7   -0.023600149
## 8        0.36316835      hours          42.3   -0.069087110
## 9        0.36316835 evaluation           2.0    0.211555782
## 10       0.36316835     salary           2.0    0.045812879
## 11       0.04650296     gender           2.0    0.011238718
## 12       0.04650296        age          57.7    0.008245777
## 13       0.04650296      hours          42.3   -0.192254560
## 14       0.04650296 evaluation           2.0   -0.321486112
## 15       0.04650296     salary           2.0    0.030592006
##            feature_desc                      data          prediction
## 1         gender = male 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 2            50.0 &lt; age 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 3  37.6 &lt; hours &lt;= 46.3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 4       evaluation &lt;= 3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 5       1 &lt; salary &lt;= 2 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 6         gender = male 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 7            50.0 &lt; age 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 8  37.6 &lt; hours &lt;= 46.3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 9       evaluation &lt;= 3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 10      1 &lt; salary &lt;= 2 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 11        gender = male 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 12           50.0 &lt; age 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 13 37.6 &lt; hours &lt;= 46.3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 14      evaluation &lt;= 3 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008
## 15      1 &lt; salary &lt;= 2 2.0, 57.7, 42.3, 2.0, 2.0 0.818, 0.174, 0.008</code></pre>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="kw">plot_features</span>(explanations)</a></code></pre></div>
<p><img src="PM_VEE_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p><strong>The live package</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;live&quot;</span>)</a>
<a class="sourceLine" id="cb34-2" data-line-number="2">new_observation<span class="op">$</span>status &lt;-<span class="st"> &quot;fired&quot;</span></a>
<a class="sourceLine" id="cb34-3" data-line-number="3"></a>
<a class="sourceLine" id="cb34-4" data-line-number="4">similar &lt;-<span class="st"> </span><span class="kw">sample_locally2</span>(<span class="dt">data =</span> HR,</a>
<a class="sourceLine" id="cb34-5" data-line-number="5">                           <span class="dt">explained_instance =</span> new_observation,</a>
<a class="sourceLine" id="cb34-6" data-line-number="6">                           <span class="dt">explained_var =</span> <span class="st">&quot;status&quot;</span>,</a>
<a class="sourceLine" id="cb34-7" data-line-number="7">                           <span class="dt">method =</span> <span class="st">&quot;lime&quot;</span>,</a>
<a class="sourceLine" id="cb34-8" data-line-number="8">                           <span class="dt">size =</span> <span class="dv">500</span>)</a>
<a class="sourceLine" id="cb34-9" data-line-number="9">similar &lt;-<span class="st"> </span><span class="kw">sample_locally2</span>(<span class="dt">data =</span> HR,</a>
<a class="sourceLine" id="cb34-10" data-line-number="10">                           <span class="dt">explained_instance =</span> new_observation,</a>
<a class="sourceLine" id="cb34-11" data-line-number="11">                           <span class="dt">explained_var =</span> <span class="st">&quot;status&quot;</span>,</a>
<a class="sourceLine" id="cb34-12" data-line-number="12">                           <span class="dt">size =</span> <span class="dv">500</span>)</a>
<a class="sourceLine" id="cb34-13" data-line-number="13">similar1 &lt;-<span class="st"> </span><span class="kw">add_predictions2</span>(<span class="dt">to_explain =</span> similar,</a>
<a class="sourceLine" id="cb34-14" data-line-number="14">                             <span class="dt">black_box_model =</span> rf_model, </a>
<a class="sourceLine" id="cb34-15" data-line-number="15">                              <span class="dt">predict_fun =</span> <span class="cf">function</span>(m,x) <span class="kw">predict</span>(m,x,<span class="dt">type=</span><span class="st">&quot;prob&quot;</span>)[,<span class="dv">1</span>])</a>
<a class="sourceLine" id="cb34-16" data-line-number="16">HR_explanation &lt;-<span class="st"> </span><span class="kw">fit_explanation2</span>(<span class="dt">live_object =</span> similar1,</a>
<a class="sourceLine" id="cb34-17" data-line-number="17">                              <span class="dt">white_box =</span> <span class="st">&quot;regr.glm&quot;</span>)</a>
<a class="sourceLine" id="cb34-18" data-line-number="18">HR_explanation</a>
<a class="sourceLine" id="cb34-19" data-line-number="19"></a>
<a class="sourceLine" id="cb34-20" data-line-number="20"><span class="kw">plot</span>(HR_explanation, <span class="dt">type =</span> <span class="st">&quot;forest&quot;</span>)</a></code></pre></div>
<p><strong>The iml package</strong></p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="kw">library</span>(<span class="st">&quot;iml&quot;</span>)</a>
<a class="sourceLine" id="cb35-2" data-line-number="2"></a>
<a class="sourceLine" id="cb35-3" data-line-number="3">explainer_rf =<span class="st"> </span>Predictor<span class="op">$</span><span class="kw">new</span>(rf_model, <span class="dt">data =</span> HR[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>])</a>
<a class="sourceLine" id="cb35-4" data-line-number="4">white_box =<span class="st"> </span>LocalModel<span class="op">$</span><span class="kw">new</span>(explainer_rf, <span class="dt">x.interest =</span> new_observation[,<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>], <span class="dt">k =</span> <span class="dv">5</span>)</a>
<a class="sourceLine" id="cb35-5" data-line-number="5">white_box</a></code></pre></div>
<pre><code>## Interpretation method:  LocalModel 
## 
## 
## Analysed predictor: 
## Prediction task: unknown 
## 
## 
## Analysed data:
## Sampling from data.frame with 7847 rows and 5 columns.
## 
## Head of results:
##           beta x.recoded      effect x.original     feature feature.value
## 1  0.064810662       1.0  0.06481066       male gender=male   gender=male
## 2  0.005930432      57.7  0.34218592       57.7         age      age=57.7
## 3 -0.089717352      42.3 -3.79504398       42.3       hours    hours=42.3
## 4 -0.502319075       2.0 -1.00463815          2  evaluation  evaluation=2
## 5 -0.039951457       2.0 -0.07990291          2      salary      salary=2
## 6 -0.028497600       1.0 -0.02849760       male gender=male   gender=male
##   .class
## 1  fired
## 2  fired
## 3  fired
## 4  fired
## 5  fired
## 6     ok</code></pre>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="kw">plot</span>(white_box)</a></code></pre></div>
<p><img src="PM_VEE_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>

</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-lime">
<p>Ribeiro, Marco Tulio, Sameer Singh, and Carlos Guestrin. 2016. “Why Should I Trust You?: Explaining the Predictions of Any Classifier.” In, 1135–44. ACM Press. <a href="https://doi.org/10.1145/2939672.2939778" class="uri">https://doi.org/10.1145/2939672.2939778</a>.</p>
</div>
<div id="ref-R-lime">
<p>Pedersen, Thomas Lin, and Michaël Benesty. 2018. <em>Lime: Local Interpretable Model-Agnostic Explanations</em>. <a href="https://CRAN.R-project.org/package=lime" class="uri">https://CRAN.R-project.org/package=lime</a>.</p>
</div>
<div id="ref-R-live">
<p>Staniak, Mateusz, and Przemysław Biecek. 2018. <em>Live: Local Interpretable (Model-Agnostic) Visual Explanations</em>. <a href="https://CRAN.R-project.org/package=live" class="uri">https://CRAN.R-project.org/package=live</a>.</p>
</div>
<div id="ref-R-randomForest">
<p>Breiman, Leo, Adele Cutler, Andy Liaw, and Matthew Wiener. 2018. <em>RandomForest: Breiman and Cutler’s Random Forests for Classification and Regression</em>. <a href="https://CRAN.R-project.org/package=randomForest" class="uri">https://CRAN.R-project.org/package=randomForest</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="shapley.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="ceterisParibus.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"download": ["PM_VEE.pdf", "PM_VEE.epub"],
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
